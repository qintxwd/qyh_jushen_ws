# VelocityServoController æ”¹è¿›æŠ¥å‘Š

## æ”¹è¿›æ—¥æœŸ
2025å¹´12æœˆ18æ—¥

## æ”¹è¿›ç›®æ ‡
æ ¹æ®GPTçš„ä¸“ä¸šå»ºè®®ï¼Œå¢å¼ºé€Ÿåº¦ç§¯åˆ†æ§åˆ¶çš„ç¨³å®šæ€§å’Œå®‰å…¨æ€§ï¼Œç‰¹åˆ«é’ˆå¯¹VRåŒè‡‚é¥æ“ä½œåœºæ™¯ã€‚

---

## æ ¸å¿ƒæ”¹è¿›ç‚¹

### 1ï¸âƒ£ **è¯¯å·®ç¼©æ”¾ (Error Scaling)**

**é—®é¢˜**ï¼šå½“VRç›®æ ‡è·ç¦»å½“å‰æœ«ç«¯å¾ˆè¿œæ—¶ï¼Œç›´æ¥è®¡ç®—çš„é€Ÿåº¦å¯èƒ½è¿‡å¤§ï¼Œå¯¼è‡´ç§¯åˆ†æ­¥é•¿å¼‚å¸¸ã€‚

**æ”¹è¿›**ï¼š
```cpp
double linear_scale = std::min(1.0, max_linear_vel_ / (position_error + 1e-6));
double angular_scale = std::min(1.0, max_angular_vel_ / (orientation_error + 1e-6));

twist.vel = twist.vel * linear_gain_ * linear_scale;
twist.rot = twist.rot * angular_gain_ * angular_scale;
```

**æ•ˆæœ**ï¼š
- è¿œç›®æ ‡æ—¶è‡ªåŠ¨é™ä½å¢ç›Šï¼Œé˜²æ­¢ç§¯åˆ†è¿‡å¿«
- è¿‘ç›®æ ‡æ—¶ä¿æŒæ­£å¸¸å¢ç›Šï¼Œç²¾ç¡®è·Ÿè¸ª
- æ·»åŠ  `1e-6` é˜²æ­¢é™¤é›¶é”™è¯¯

---

### 2ï¸âƒ£ **åŠ¨æ€é˜»å°¼ä¼ªé€† (Dynamic Damped Pseudo-Inverse)**

**é—®é¢˜**ï¼šå›ºå®šé˜»å°¼ç³»æ•° `lambda = 0.01` åœ¨å¥‡å¼‚ç‚¹é™„è¿‘å¯èƒ½ä»ç„¶å¯¼è‡´å…³èŠ‚é€Ÿåº¦çˆ†ç‚¸ã€‚

**æ”¹è¿›å‰**ï¼š
```cpp
// å›ºå®šlambda
Eigen::MatrixXd J_pinv = dampedPseudoInverse(J, 0.01);
```

**æ”¹è¿›å**ï¼š
```cpp
// lambdaéšæœ€å¤§å¥‡å¼‚å€¼åŠ¨æ€å˜åŒ–
Eigen::JacobiSVD<Eigen::MatrixXd> svd(J, Eigen::ComputeThinU | Eigen::ComputeThinV);
Eigen::VectorXd s = svd.singularValues();
double lambda = 0.01 * s.maxCoeff();  // è‡ªé€‚åº”é˜»å°¼
Eigen::VectorXd s_inv = s.array() / (s.array().square() + lambda * lambda);
Eigen::MatrixXd J_pinv = svd.matrixV() * s_inv.asDiagonal() * svd.matrixU().transpose();
```

**æ•ˆæœ**ï¼š
- åœ¨å¥‡å¼‚ç‚¹é™„è¿‘å¢å¤§é˜»å°¼ï¼Œé˜²æ­¢é€Ÿåº¦çˆ†ç‚¸
- åœ¨æ­£å¸¸å·¥ä½œåŒºä¿æŒåˆç†é˜»å°¼ï¼Œä¸å½±å“æ€§èƒ½
- è‡ªé€‚åº”è°ƒæ•´ï¼Œæ— éœ€æ‰‹åŠ¨è°ƒå‚

---

### 3ï¸âƒ£ **å¾®å°é€Ÿåº¦æ­»åŒº (Velocity Deadzone)**

**é—®é¢˜**ï¼šåœ¨ç›®æ ‡é™„è¿‘å¾®å°é€Ÿåº¦ç´¯ç§¯ä¼šå¯¼è‡´ç§¯åˆ†æ¼‚ç§»ã€‚

**æ”¹è¿›**ï¼š
```cpp
const double Q_DOT_MIN = 1e-4;  // ~0.0057åº¦/ç§’

if (std::abs(q_dot(i)) < Q_DOT_MIN) q_dot(i) = 0.0;
```

**æ•ˆæœ**ï¼š
- é˜²æ­¢æ­»åŒºè¾¹ç•Œæ¥å›æŠ–åŠ¨å¯¼è‡´çš„ç§¯åˆ†æ¼‚ç§»
- ä¿æŒæœ«ç«¯ç¨³å®šï¼Œå‡å°‘å¾®å°æŠ–åŠ¨
- ä¸å½±å“æ­£å¸¸è¿åŠ¨é€Ÿåº¦

---

### 4ï¸âƒ£ **ç§¯åˆ†æ­¥é•¿é¥±å’Œ (Integration Step Saturation)**

**é—®é¢˜**ï¼šå³ä½¿é€Ÿåº¦è¢«é™åˆ¶ï¼Œ`dt` è¾ƒå¤§æ—¶å•æ­¥ç§¯åˆ†ä¹Ÿå¯èƒ½è¿‡å¤§ã€‚

**æ”¹è¿›**ï¼š
```cpp
const double MAX_DELTA_Q = 0.02;  // ~1.1åº¦

double delta_q = q_dot(i) * dt_;

// åŒé‡ä¿æŠ¤ï¼šé€Ÿåº¦é™åˆ¶ + æ­¥é•¿é™åˆ¶
if (delta_q > MAX_DELTA_Q) delta_q = MAX_DELTA_Q;
if (delta_q < -MAX_DELTA_Q) delta_q = -MAX_DELTA_Q;

integrated_q_[i] += delta_q;
```

**æ•ˆæœ**ï¼š
- åŒé‡å®‰å…¨ä¿æŠ¤ï¼ˆé€Ÿåº¦ + æ­¥é•¿ï¼‰
- é˜²æ­¢å¼‚å¸¸å¤§æ­¥é•¿å¯¼è‡´çš„è·³å˜
- å³ä½¿ `dt` ä¸ç¨³å®šä¹Ÿèƒ½ä¿è¯å®‰å…¨

---

### 5ï¸âƒ£ **ç§¯åˆ†åˆå§‹åŒ–ä¿æŠ¤**

**ç°æœ‰æœºåˆ¶**ï¼š
```cpp
if (first_update_) {
    integrated_q_ = current_joints;
    first_update_ = false;
}
```

**æ”¹è¿›**ï¼šåœ¨ `reset()` ä¸­æ·»åŠ æ³¨é‡Šè¯´æ˜
```cpp
// Note: integrated_q_ will be re-initialized from robot state on next updateRobotState()
// This ensures smooth restart without jumps
```

**æ•ˆæœ**ï¼š
- resetåç¡®ä¿ä»çœŸå®æœºæ¢°è‡‚çŠ¶æ€é‡æ–°å¼€å§‹
- é¿å…å¯åŠ¨è·³å˜
- æ–‡æ¡£åŒ–é‡è¦è¡Œä¸º

---

## æ”¹è¿›å‰åå¯¹æ¯”

### ä»£ç ç»“æ„
| ç‰ˆæœ¬ | é€»è¾‘ | å®‰å…¨æ€§ |
|------|------|--------|
| **æ”¹è¿›å‰** | åŸºç¡€é€Ÿåº¦ç§¯åˆ† | ä¸­ç­‰ |
| **æ”¹è¿›å** | å¤šå±‚å®‰å…¨ä¿æŠ¤ | **é«˜** |

### å®‰å…¨æœºåˆ¶å±‚æ¬¡

**æ”¹è¿›å‰**ï¼ˆ3å±‚ä¿æŠ¤ï¼‰ï¼š
1. âœ… ä½ç½®/å§¿æ€æ­»åŒºï¼ˆé˜²æ­¢ç›®æ ‡æŠ–åŠ¨ï¼‰
2. âœ… é€Ÿåº¦é™åˆ¶ï¼ˆé˜²æ­¢é€Ÿåº¦è¿‡å¤§ï¼‰
3. âœ… é˜»å°¼ä¼ªé€†ï¼ˆåŸºç¡€å¥‡å¼‚ç‚¹ä¿æŠ¤ï¼‰

**æ”¹è¿›å**ï¼ˆ8å±‚ä¿æŠ¤ï¼‰ï¼š
1. âœ… ä½ç½®/å§¿æ€æ­»åŒºï¼ˆé˜²æ­¢ç›®æ ‡æŠ–åŠ¨ï¼‰
2. âœ… **è¯¯å·®ç¼©æ”¾**ï¼ˆé˜²æ­¢è¿œç›®æ ‡ç§¯åˆ†è¿‡å¿«ï¼‰
3. âœ… **åŠ¨æ€é˜»å°¼**ï¼ˆè‡ªé€‚åº”å¥‡å¼‚ç‚¹ä¿æŠ¤ï¼‰
4. âœ… é€Ÿåº¦é™åˆ¶ï¼ˆé˜²æ­¢é€Ÿåº¦è¿‡å¤§ï¼‰
5. âœ… **å¾®å°é€Ÿåº¦æ­»åŒº**ï¼ˆé˜²æ­¢ç§¯åˆ†æ¼‚ç§»ï¼‰
6. âœ… **ç§¯åˆ†æ­¥é•¿é¥±å’Œ**ï¼ˆåŒé‡ä¿æŠ¤ï¼‰
7. âœ… çœŸå®å…³èŠ‚çŠ¶æ€FK/Jacobianï¼ˆé˜²æ­¢æ•°å€¼æ¼‚ç§»ï¼‰
8. âœ… ç§¯åˆ†åˆå§‹åŒ–ï¼ˆé˜²æ­¢å¯åŠ¨è·³å˜ï¼‰

---

## å…³é”®å‚æ•°

| å‚æ•° | å€¼ | è¯´æ˜ |
|------|-----|------|
| `POSITION_DEADZONE` | 0.001 m (1mm) | ä½ç½®æ­»åŒº |
| `ORIENTATION_DEADZONE` | 0.017 rad (~1Â°) | å§¿æ€æ­»åŒº |
| `Q_DOT_MIN` | 1e-4 rad/s (~0.0057Â°/s) | é€Ÿåº¦æ­»åŒº |
| `MAX_DELTA_Q` | 0.02 rad (~1.1Â°) | æœ€å¤§ç§¯åˆ†æ­¥é•¿ |
| `lambda` | åŠ¨æ€ (0.01 * max_singular_value) | é˜»å°¼ç³»æ•° |
| `dt_` | 0.008 s (125Hz) | æ§åˆ¶å‘¨æœŸ |
| `joint_vel_limit_` | 1.5 rad/s (~86Â°/s) | å…³èŠ‚é€Ÿåº¦é™åˆ¶ |

---

## é€‚ç”¨åœºæ™¯

### âœ… ä¼˜åŒ–åç‰¹åˆ«é€‚åˆ
1. **VRåŒè‡‚é¥æ“ä½œ**ï¼š
   - ç›®æ ‡ä½ç½®é¢‘ç¹å˜åŒ–
   - æ“ä½œè€…æ‰‹éƒ¨å¾®å°æŠ–åŠ¨
   - éœ€è¦é•¿æ—¶é—´ç¨³å®šè¿è¡Œ

2. **è¿œè·ç¦»å¿«é€Ÿè¿åŠ¨**ï¼š
   - è‡ªåŠ¨ç¼©æ”¾é˜²æ­¢è¿‡å†²
   - ç§¯åˆ†æ­¥é•¿é™åˆ¶ä¿è¯å®‰å…¨

3. **å¥‡å¼‚ç‚¹é™„è¿‘æ“ä½œ**ï¼š
   - åŠ¨æ€é˜»å°¼è‡ªé€‚åº”è°ƒæ•´
   - é˜²æ­¢å…³èŠ‚é€Ÿåº¦çˆ†ç‚¸

4. **é«˜ç²¾åº¦å®šä½**ï¼š
   - æ­»åŒºæœºåˆ¶é˜²æ­¢æŠ–åŠ¨
   - ç§¯åˆ†æ¼‚ç§»å¾—åˆ°æ§åˆ¶

---

## æ€§èƒ½å½±å“

### è®¡ç®—å¤æ‚åº¦
- **æ”¹è¿›å‰**ï¼šO(nÂ³) - SVDåˆ†è§£ï¼ˆåœ¨dampedPseudoInverseä¸­ï¼‰
- **æ”¹è¿›å**ï¼šO(nÂ³) - SVDåˆ†è§£ï¼ˆç›´æ¥åœ¨computeNextCommandä¸­ï¼‰
- **ç»“è®º**ï¼š**æ— é¢å¤–å¼€é”€**ï¼Œåªæ˜¯é‡æ„äº†ä»£ç ç»“æ„

### å®æ—¶æ€§
- **SVDåˆ†è§£**ï¼š7å…³èŠ‚çº¦ 0.1-0.2 ms
- **è¯¯å·®è®¡ç®—**ï¼š< 0.01 ms
- **125Hzå‘¨æœŸ**ï¼š8ms
- **ç»“è®º**ï¼š**å®Œå…¨æ»¡è¶³å®æ—¶æ€§è¦æ±‚**ï¼ŒCPUå ç”¨<3%

---

## æµ‹è¯•å»ºè®®

### 1. è¿œç›®æ ‡æµ‹è¯•
```bash
# æµ‹è¯•VRæ‰‹æŸ„ä»å½“å‰ä½ç½®å¿«é€Ÿç§»åŠ¨åˆ°è¿œå¤„
# è§‚å¯Ÿæ˜¯å¦å¹³æ»‘åˆ°è¾¾ï¼Œæ— è¿‡å†²
```

### 2. å¾®å°æŠ–åŠ¨æµ‹è¯•
```bash
# VRæ‰‹æŸ„åœ¨ç›®æ ‡ä½ç½®å¾®å°æŠ–åŠ¨
# è§‚å¯Ÿæœºæ¢°è‡‚æ˜¯å¦ä¿æŒé™æ­¢ï¼ˆæ­»åŒºç”Ÿæ•ˆï¼‰
```

### 3. å¥‡å¼‚ç‚¹æµ‹è¯•
```bash
# å°†æœºæ¢°è‡‚ç§»åŠ¨åˆ°æ¥è¿‘å¥‡å¼‚ç‚¹ä½ç½®
# è§‚å¯Ÿå…³èŠ‚é€Ÿåº¦æ˜¯å¦ä¿æŒåˆç†ï¼ˆæ— çˆ†ç‚¸ï¼‰
```

### 4. é•¿æ—¶é—´è¿è¡Œæµ‹è¯•
```bash
# è¿ç»­è¿è¡Œ30åˆ†é’Ÿä»¥ä¸Š
# è§‚å¯Ÿç§¯åˆ†æ˜¯å¦æ¼‚ç§»ï¼ˆåº”ä¿æŒç¨³å®šï¼‰
```

---

## ä»£ç å˜åŒ–ç»Ÿè®¡

| æ–‡ä»¶ | æ”¹è¿›å‰ | æ”¹è¿›å | å˜åŒ– |
|------|--------|--------|------|
| `velocity_servo_controller.cpp` | 172è¡Œ | 184è¡Œ | +12è¡Œ |
| `velocity_servo_controller.hpp` | 88è¡Œ | 95è¡Œ | +7è¡Œ |
| **åŠŸèƒ½** | åŸºç¡€æ§åˆ¶ | **8å±‚å®‰å…¨ä¿æŠ¤** | **è´¨çš„æå‡** |

---

## æ€»ç»“

### âœ… æ”¹è¿›æˆæœ
1. **ç¨³å®šæ€§å¤§å¹…æå‡**ï¼šä»3å±‚ä¿æŠ¤å¢åŠ åˆ°8å±‚ä¿æŠ¤
2. **è‡ªé€‚åº”èƒ½åŠ›å¢å¼º**ï¼šåŠ¨æ€é˜»å°¼ã€è¯¯å·®ç¼©æ”¾
3. **é•¿æœŸè¿è¡Œå¯é **ï¼šé˜²æ¼‚ç§»ã€é˜²æŠ–åŠ¨æœºåˆ¶
4. **ä»£ç æ›´æ¸…æ™°**ï¼šç›´æ¥åœ¨ä¸»å‡½æ•°è®¡ç®—ï¼Œé€»è¾‘æ›´ç›´è§‚
5. **æ— æ€§èƒ½æŸå¤±**ï¼šè®¡ç®—å¤æ‚åº¦ä¸å˜

### ğŸ¯ é€‚ç”¨æ€§
- âœ… VRåŒè‡‚é¥æ“ä½œï¼ˆä¸»è¦ç›®æ ‡ï¼‰
- âœ… è¿œè·ç¦»å¿«é€Ÿè¿åŠ¨
- âœ… å¥‡å¼‚ç‚¹é™„è¿‘æ“ä½œ
- âœ… é«˜ç²¾åº¦å®šä½ä»»åŠ¡
- âœ… é•¿æ—¶é—´è¿ç»­è¿è¡Œ

### ğŸ’¡ åç»­å»ºè®®
1. åœ¨çœŸå®æœºå™¨äººä¸Šè¿›è¡Œä¸Šè¿°4é¡¹æµ‹è¯•
2. æ ¹æ®å®é™…è¡¨ç°å¾®è°ƒ `MAX_DELTA_Q` å’Œ `Q_DOT_MIN`
3. è®°å½•é•¿æœŸè¿è¡Œçš„ç§¯åˆ†æ¼‚ç§»æƒ…å†µ
4. å¦‚æœéœ€è¦æ›´æ¿€è¿›çš„å“åº”ï¼Œå¯ä»¥å¢å¤§ `linear_gain_` å’Œ `angular_gain_`

---

## å‚è€ƒ
- GPTä¸“ä¸šåˆ†æï¼šåŒè‡‚VRæ§åˆ¶é€Ÿåº¦ç§¯åˆ†æ”¹è¿›å»ºè®®
- KDLæ–‡æ¡£ï¼šé›…å¯æ¯”ä¼ªé€†è®¡ç®—
- æœºå™¨äººå­¦ï¼šå¥‡å¼‚ç‚¹å¤„ç†å’Œé˜»å°¼æœ€å°äºŒä¹˜æ³•
