# qyh_dual_arm_ik_solver

åŒè‡‚é€†è¿åŠ¨å­¦æ±‚è§£èŠ‚ç‚¹ - VRé¥æ“ä½œä¸“ç”¨

## ðŸŽ¯ åŠŸèƒ½

- **ç¬¬äºŒå®¢æˆ·ç«¯è¿žæŽ¥**ï¼šä½œä¸ºç¬¬äºŒä¸ªå®¢æˆ·ç«¯è¿žæŽ¥åˆ°JAKAæŽ§åˆ¶å™¨ï¼ˆqyh_jaka_controlæ˜¯ç¬¬ä¸€ä¸ªï¼‰
- **é«˜é¢‘IKæ±‚è§£**ï¼š125Hzé¢‘çŽ‡å®žæ—¶æ±‚è§£åŒè‡‚é€†è¿åŠ¨å­¦
- **æ— ç¼é›†æˆ**ï¼šè®¢é˜…VRç›®æ ‡ä½å§¿ï¼Œå‘å¸ƒå…³èŠ‚æŒ‡ä»¤

## ðŸ—ï¸ æž¶æž„å®šä½

```
VR â†’ coordinate_mapper â†’ /teleop/left_hand/target
                              â†“
                    [dual_arm_ik_solver] â† ç¬¬äºŒä¸ªJAKAè¿žæŽ¥
                              â†“
                    /left_arm/joint_command
                              â†“
                    qyh_jaka_control (ä¼ºæœæŽ§åˆ¶)
```

## ðŸ“‹ èŠ‚ç‚¹ä¿¡æ¯

### è®¢é˜…è¯é¢˜
- `/teleop/left_hand/target` (geometry_msgs/PoseStamped) - å·¦æ‰‹ç›®æ ‡ä½å§¿ (frame_id="vr_origin")
- `/teleop/right_hand/target` (geometry_msgs/PoseStamped) - å³æ‰‹ç›®æ ‡ä½å§¿ (frame_id="vr_origin")
- `/joint_states` (sensor_msgs/JointState) - å½“å‰å…³èŠ‚çŠ¶æ€ï¼ˆç”¨ä½œIKå‚è€ƒï¼‰
- `/jaka/robot_state` (qyh_jaka_control_msgs/RobotState) - æœºæ¢°è‡‚çœŸå®žä½å§¿çŠ¶æ€

### å‘å¸ƒè¯é¢˜
- `/left_arm/joint_command` (sensor_msgs/JointState) - å·¦è‡‚å…³èŠ‚æŒ‡ä»¤
- `/right_arm/joint_command` (sensor_msgs/JointState) - å³è‡‚å…³èŠ‚æŒ‡ä»¤
- `/ik_solver/status` (std_msgs/Bool) - IKæ±‚è§£çŠ¶æ€

### å‚æ•°
- `robot_ip`: JAKAæŽ§åˆ¶å™¨IPåœ°å€ï¼ˆé»˜è®¤: 192.168.2.200ï¼‰
- `ik_rate`: IKæ±‚è§£é¢‘çŽ‡ï¼ˆé»˜è®¤: 125.0 Hzï¼‰
- `auto_connect`: è‡ªåŠ¨è¿žæŽ¥æŽ§åˆ¶å™¨ï¼ˆé»˜è®¤: trueï¼‰
- `publish_debug_tf`: å‘å¸ƒè°ƒè¯•TFåæ ‡ç³»ï¼ˆé»˜è®¤: trueï¼‰
- `target_x_left`: ç›®æ ‡åæ ‡ç³»Xè½´æ˜¯å¦å‘å·¦ï¼ˆé»˜è®¤: falseï¼Œå³Xè½´å‘å‰ï¼‰
- `has_z_offset`: æ˜¯å¦åº”ç”¨Zè½´åç§»ï¼ˆé»˜è®¤: trueï¼‰
- `left_z_offset`: å·¦è‡‚Zè½´åç§»é‡ï¼ˆé»˜è®¤: 0.219885132 mï¼‰
- `right_z_offset`: å³è‡‚Zè½´åç§»é‡ï¼ˆé»˜è®¤: 0.217950931 mï¼‰

## ðŸš€ ä½¿ç”¨æ–¹æ³•

### 1. ç¼–è¯‘
```bash
cd ~/qyh_jushen_ws/qyh_jushen_ws
colcon build --packages-select qyh_dual_arm_ik_solver
source install/setup.bash
```

### 2. å¯åŠ¨å®Œæ•´é¥æ“ä½œç³»ç»Ÿ

**ç»ˆç«¯1 - JAKAæŽ§åˆ¶èŠ‚ç‚¹ï¼ˆä¸»è¿žæŽ¥ï¼‰ï¼š**
```bash
ros2 launch qyh_jaka_control jaka_control.launch.py
```

**ç»ˆç«¯2 - VRé¥æ“ä½œèŠ‚ç‚¹ï¼š**
```bash
ros2 launch qyh_dual_arm_teleop teleop.launch.py
```

**ç»ˆç«¯3 - IKæ±‚è§£èŠ‚ç‚¹ï¼ˆç¬¬äºŒè¿žæŽ¥ï¼‰ï¼š**
```bash
ros2 launch qyh_dual_arm_ik_solver ik_solver.launch.py
```

### 3. éªŒè¯è¿è¡Œ

**æŸ¥çœ‹IKç»Ÿè®¡ï¼š**
```bash
# åº”è¯¥çœ‹åˆ°ï¼š
# ðŸ“Š IKç»Ÿè®¡: å·¦è‡‚æˆåŠŸçŽ‡=XX%, å³è‡‚æˆåŠŸçŽ‡=XX%, æ€»è®¡=XXXæ¬¡
```

**æŸ¥çœ‹å…³èŠ‚æŒ‡ä»¤ï¼š**
```bash
ros2 topic echo /left_arm/joint_command
ros2 topic hz /left_arm/joint_command  # åº”è¯¥çº¦125Hz
```

## ðŸ”§ é…ç½®è¯´æ˜Ž

ç¼–è¾‘ `config/ik_solver_params.yaml`ï¼š

```yaml
robot_ip: "192.168.2.200"      # ä¸Žqyh_jaka_controlç›¸åŒ
ik_rate: 125.0                 # åŒ¹é…ä¼ºæœå‘¨æœŸ
auto_connect: true             # å¯åŠ¨æ—¶è‡ªåŠ¨è¿žæŽ¥
publish_debug_tf: true         # å‘å¸ƒè°ƒè¯•åæ ‡ç³»
target_x_left: false           # false=Xè½´å‘å‰ï¼Œtrue=Xè½´å‘å·¦
has_z_offset: true             # åº”ç”¨Zè½´åç§»è¡¥å¿
left_z_offset: 0.219885132     # å·¦è‡‚é›¶ä½Zåç§»(m)
right_z_offset: 0.217950931    # å³è‡‚é›¶ä½Zåç§»(m)
```

### å‚æ•°è¯´æ˜Ž

**åæ ‡ç³»ç›¸å…³ï¼š**
- `target_x_left`: æ ¹æ®ä¸Šæ¸¸èŠ‚ç‚¹å‘é€çš„åæ ‡ç³»çº¦å®šè®¾ç½®
  - `false`: ç›®æ ‡åæ ‡ç³»ä¸º [Xå‰, Yå·¦, Zä¸Š]ï¼ˆé»˜è®¤ï¼Œäººæ‰‹è¯­ä¹‰ï¼‰
  - `true`: ç›®æ ‡åæ ‡ç³»ä¸º [Xå·¦, Yä¸Š, Zå‰]ï¼ˆéœ€è¦æ—‹è½¬ï¼‰
  
- `has_z_offset`: æ˜¯å¦è¡¥å¿æœºæ¢°è‡‚é›¶ä½æ—¶çš„Zè½´åç§»
  - `true`: åº”ç”¨åç§»ï¼ˆæŽ¨èï¼Œç¡®ä¿æ­£ç¡®å¯¹é½ï¼‰
  - `false`: ä¸åº”ç”¨åç§»ï¼ˆä»…ç”¨äºŽè°ƒè¯•ï¼‰

**Zè½´åç§»å€¼ï¼š**
- è¿™äº›å€¼æ¥è‡ªJAKAæ­£è§£ï¼Œæœºæ¢°è‡‚åœ¨å…¨é›¶å…³èŠ‚æ—¶çš„æœ«ç«¯Zåæ ‡
- å·¦è‡‚: 219.885132 mm = 0.219885132 m
- å³è‡‚: 217.950931 mm = 0.217950931 m

## âš ï¸ é‡è¦è¯´æ˜Ž

### åæ ‡ç³»å¤„ç† â­æ ¸å¿ƒ
æœ¬èŠ‚ç‚¹è´Ÿè´£å®Œæ•´çš„åæ ‡ç³»è½¬æ¢æµç¨‹ï¼š

1. **æŽ¥æ”¶VRç©ºé—´ä½å§¿**
   - è¾“å…¥ï¼š`/teleop/left_hand/target` (frame_id="vr_origin")
   - coordinate_mapperå·²å®ŒæˆVRâ†’äººæ‰‹è¯­ä¹‰çš„æ˜ å°„

2. **TFåæ ‡ç³»è½¬æ¢**
   - é€šè¿‡TFè‡ªåŠ¨æŸ¥è¯¢å®Œæ•´å˜æ¢é“¾
   - `vr_origin` â†’ `teleop_base` â†’ `base_link` â†’ `base_link_left/right`
   - è‡ªåŠ¨åŒ…å«é›¶ä½æ ¡å‡†ã€æœºå™¨äººé…ç½®ç­‰æ‰€æœ‰å˜æ¢

3. **æœ«ç«¯åæ ‡ç³»æ ¡æ­£**
   - human_hand: [Xå‰, Yå·¦, Zä¸Š] (äººæ‰‹è¯­ä¹‰)
   - lt/rt: [Xå·¦, Yä¸Š, ZåŽ] (JAKAæœ«ç«¯)
   - åº”ç”¨Zè½´æ—‹è½¬æ ¡æ­£ï¼ˆå·¦è‡‚-90Â°ï¼Œå³è‡‚+90Â°ï¼‰

4. **è°ƒç”¨JAKA IK**
   - è¾“å…¥å·²åœ¨`base_link_left/right`åæ ‡ç³»
   - ä½¿ç”¨å½“å‰å…³èŠ‚çŠ¶æ€ä½œä¸ºå‚è€ƒ

### å¤šå®¢æˆ·ç«¯è¿žæŽ¥
- âœ… JAKA SDKæ”¯æŒ**æœ€å¤š2ä¸ªå®¢æˆ·ç«¯**åŒæ—¶è¿žæŽ¥
- ðŸ”Œ qyh_jaka_control = ç¬¬ä¸€è¿žæŽ¥ï¼ˆä¸»æŽ§åˆ¶ï¼‰
- ðŸ”Œ qyh_dual_arm_ik_solver = ç¬¬äºŒè¿žæŽ¥ï¼ˆIKæ±‚è§£ï¼‰
- âŒ ç¬¬ä¸‰ä¸ªè¿žæŽ¥ä¼šå¤±è´¥

### IKå‚è€ƒä½ç½®
æœ¬èŠ‚ç‚¹ä½¿ç”¨**å¤šçº§å‚è€ƒç­–ç•¥**ç¡®ä¿IKè§£çš„è¿žç»­æ€§ï¼š

1. **ä¼˜å…ˆçº§1 - å½“å‰å…³èŠ‚çŠ¶æ€**ï¼ˆæ¥è‡ª `/joint_states`ï¼‰
   - ä½¿ç”¨æœºæ¢°è‡‚å®žé™…å…³èŠ‚è§’åº¦ä½œä¸ºIKå‚è€ƒ
   - ç¡®ä¿è§£çš„è¿žç»­æ€§ï¼Œé¿å…çªå˜
   
2. **ä¼˜å…ˆçº§2 - é¢„è®¾å‚è€ƒä½ç½®**ï¼ˆä»£ç ä¸­ç¡¬ç¼–ç ï¼‰
   - å·¦è‡‚: `[0.004677, -1.030041, 0.003351, -1.398358, -0.001902, 1.397188, 0.000262]`
   - å³è‡‚: `[-0.001571, -1.134639, -0.005952, -1.395653, 0.004590, -1.744875, -0.000279]`
   - å¯¹åº”æœºæ¢°è‡‚"åŒæ‰‹å‘å‰åˆæ‹¢"çš„è‡ªç„¶å§¿æ€

### åæ ‡ç³»çº¦å®š
- **è¾“å…¥åæ ‡ç³»**: VRç©ºé—´ (`vr_origin`) æˆ– æœºå™¨äººåŸºåº§ (`base_link_left/right`)
- **æœ«ç«¯åæ ‡ç³»**: 
  - äººæ‰‹è¯­ä¹‰: [Xå‰, Yå·¦, Zä¸Š]
  - JAKAæœ«ç«¯(lt/rt): [Xå·¦, Yä¸Š, ZåŽ]
- **robot_id**: 0=å·¦è‡‚, 1=å³è‡‚
- **å•ä½è½¬æ¢**: 
  - ä½ç½®: ç±³ (m) â†’ æ¯«ç±³ (mm)
  - å§¿æ€: å››å…ƒæ•° â†’ æ¬§æ‹‰è§’ (rad)

### å…³èŠ‚é™ä½ä¿æŠ¤
èŠ‚ç‚¹å†…ç½®JAKA Zu7å…³èŠ‚é™ä½æ£€æŸ¥ï¼š
- **ä½ç½®é™ä½**: å„å…³èŠ‚Â±360Â°æˆ–ç‰¹å®šèŒƒå›´ï¼ˆå¸¦5Â°å®‰å…¨è£•åº¦ï¼‰
- **é€Ÿåº¦é™ä½**: 90Â°/s ~ 150Â°/sï¼ˆå…è®¸20%è¶…å‡ºä»¥åº”å¯¹IKçªå˜ï¼‰
- è¶…é™æ—¶è‡ªåŠ¨æ‹’ç»IKè§£ï¼Œä¿æŠ¤æœºæ¢°è‡‚å®‰å…¨

## ðŸ“Š æ€§èƒ½æŒ‡æ ‡

- **IKæ±‚è§£é¢‘çŽ‡**: 125 Hz
- **æˆåŠŸçŽ‡**: >95% (å·¥ä½œç©ºé—´å†…)
- **å»¶è¿Ÿ**: <8ms (å•æ¬¡æ±‚è§£)

## ðŸ› æ•…éšœæŽ’æŸ¥

### é—®é¢˜1ï¼šè¿žæŽ¥å¤±è´¥
```
âŒ è¿žæŽ¥å¤±è´¥ï¼é”™è¯¯ç : -1
```
**åŽŸå› **ï¼šqyh_jaka_controlæœªè¿è¡Œæˆ–å·²æœ‰2ä¸ªè¿žæŽ¥
**è§£å†³**ï¼šç¡®è®¤ç¬¬ä¸€ä¸ªèŠ‚ç‚¹è¿è¡Œæ­£å¸¸ï¼Œæœ€å¤š2ä¸ªè¿žæŽ¥

### é—®é¢˜2ï¼šIKæˆåŠŸçŽ‡ä½Ž
```
å·¦è‡‚IKå¤±è´¥ (é”™è¯¯ç : -4)
```
**å¯èƒ½åŽŸå› **ï¼š
1. ç›®æ ‡ä½å§¿è¶…å‡ºå·¥ä½œç©ºé—´
2. æŽ¥è¿‘å¥‡å¼‚ç‚¹é…ç½®
3. ç›®æ ‡å§¿æ€ä¸Žæœ«ç«¯åæ ‡ç³»ä¸åŒ¹é…

**è§£å†³æ–¹æ³•**ï¼š
- æ£€æŸ¥VRç›®æ ‡ä½å§¿æ˜¯å¦åˆç†
- ç¡®è®¤ `target_x_left` å‚æ•°ä¸Žä¸Šæ¸¸èŠ‚ç‚¹ä¸€è‡´
- æŸ¥çœ‹ `/jaka/robot_state` ç¡®è®¤å½“å‰ä½å§¿
- ä½¿ç”¨æµ‹è¯•è„šæœ¬éªŒè¯ï¼š`ros2 run qyh_dual_arm_ik_solver test_publish_targets.py`

### é—®é¢˜3ï¼šè¯é¢˜æ— æ•°æ®
```bash
ros2 topic hz /left_arm/joint_command
# æ˜¾ç¤º: no messages received
```
**åŽŸå› **ï¼šæœªæ”¶åˆ°VRç›®æ ‡ä½å§¿
**è§£å†³**ï¼š
- ç¡®è®¤coordinate_mapperèŠ‚ç‚¹è¿è¡Œ: `ros2 node list | grep coordinate`
- æ£€æŸ¥ç›®æ ‡è¯é¢˜: `ros2 topic echo /teleop/left_hand/target`
- æŸ¥çœ‹èŠ‚ç‚¹æ—¥å¿—: `ros2 node info /dual_arm_ik_solver_node`

### é—®é¢˜4ï¼šåæ ‡ç³»é”™ä½
```
IKè§£ç®—æˆåŠŸä½†æœºæ¢°è‡‚è¿åŠ¨æ–¹å‘é”™è¯¯
```
**åŽŸå› **ï¼šåæ ‡ç³»é…ç½®ä¸åŒ¹é…
**è§£å†³**ï¼š
- æ£€æŸ¥ `target_x_left` å‚æ•°ï¼ˆfalse=Xå‘å‰ï¼Œtrue=Xå‘å·¦ï¼‰
- ç¡®è®¤ `has_z_offset` å’Œåç§»å€¼æ­£ç¡®
- æŸ¥çœ‹è°ƒè¯•TFï¼š`ros2 run tf2_tools view_frames.py` ï¼ˆéœ€è¦ `publish_debug_tf: true`ï¼‰

## ðŸ§ª æµ‹è¯•å·¥å…·

### æ‰‹åŠ¨æµ‹è¯•è„šæœ¬
ä½¿ç”¨å†…ç½®æµ‹è¯•è„šæœ¬éªŒè¯IKæ±‚è§£ï¼š

```bash
# å‘å¸ƒé¢„è®¾æµ‹è¯•ä½å§¿ï¼ˆä¸¤å¥—é¢„è®¾å¯é€‰ï¼‰
ros2 run qyh_dual_arm_ik_solver test_publish_targets.py
```

**é¢„è®¾1 - é›¶ä½å§¿æ€**ï¼š
- å…¨0å…³èŠ‚å¯¹åº”çš„æ­£è§£ä½å§¿
- é€‚åˆéªŒè¯åŸºç¡€IKåŠŸèƒ½

**é¢„è®¾2 - åˆæ‹¢å§¿æ€**ï¼š
- åŒæ‰‹å‘å‰åˆæ‹¢çš„è‡ªç„¶å§¿æ€
- å¸¦Zè½´æ­£å¼¦æ³¢åŠ¨ï¼Œæµ‹è¯•è¿žç»­è¿åŠ¨

### è°ƒè¯•æŠ€å·§
1. **æŸ¥çœ‹TFæ ‘**ï¼š`ros2 run tf2_tools view_frames.py`
2. **ç›‘æŽ§IKçŠ¶æ€**ï¼š`ros2 topic echo /ik_solver/status`
3. **æŸ¥çœ‹å…³èŠ‚æŒ‡ä»¤**ï¼š`ros2 topic echo /left_arm/joint_command`
4. **æ£€æŸ¥è§£ç®—é¢‘çŽ‡**ï¼š`ros2 topic hz /left_arm/joint_command`

## ðŸ”— ç›¸å…³æ–‡æ¡£

- [COORDINATE_SYSTEM_FIX.md](COORDINATE_SYSTEM_FIX.md) - åæ ‡ç³»ä¿®å¤è¯¦è§£
- [TF_design.md](../../TF_design.md) - VRé¥æ“ä½œæž¶æž„è®¾è®¡
- [qyh_dual_arm_teleop/README.md](../qyh_dual_arm_teleop/README.md) - VRé¥æ“ä½œèŠ‚ç‚¹
- [qyh_jaka_control/README.md](../qyh_jaka_control/README.md) - JAKAæŽ§åˆ¶èŠ‚ç‚¹
