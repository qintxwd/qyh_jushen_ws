# VR位置映射标定指南

## 概述

由于机械臂工作空间与人体手臂活动范围不同，需要对VR手柄位置进行映射变换：

```
P'(机械臂) = Scale * P(VR) + Offset
```

使用**4个标准姿态**自动计算最优映射参数。

---

## 快速开始

### 1. 准备工作

- ✅ VR手柄已开启并连接
- ✅ `vr_to_base_vr`节点正在运行
- ✅ 准备好4个标准姿态的机械臂目标位置

### 2. 运行标定工具

```bash
cd ~/qyh_jushen_ws
source install/setup.bash
ros2 run dual_arms calibrate_vr_mapping.py
```

### 3. 标定流程

脚本会引导您完成以下步骤：

#### 左手标定（4个姿态）

| 姿态 | 说明 | 操作 |
|------|------|------|
| 1 | 双臂打开，与肩平齐 | 摆好姿势 → 按回车 → 输入机械臂目标XYZ |
| 2 | 双臂垂直放下 | 摆好姿势 → 按回车 → 输入机械臂目标XYZ |
| 3 | 双臂水平前伸 | 摆好姿势 → 按回车 → 输入机械臂目标XYZ |
| 4 | 双臂低位前伸（端托盘） | 摆好姿势 → 按回车 → 输入机械臂目标XYZ |

#### 右手标定（同样4个姿态）

重复上述步骤。

### 4. 自动计算并保存

标定完成后，参数自动保存到：
```
src/dual_arms/config/vr_mapping_calibration.yaml
```

---

## 标定示例

### 典型交互流程

```
姿态 1/5: 双臂打开，与肩平齐
-----4------------------------------------------------------
请摆好姿态1，然后按回车记录VR位置... [按回车]

✓ VR位置: X=0.450, Y=1.200, Z=-0.300

请输入机械臂左手在此姿态的目标位置:
  X (米): 0.6
  Y (米): 0.3
  Z (米): 0.8

✓ 机械臂目标: X=0.600, Y=0.300, Z=0.800
✓ 姿态1数据已记录
```

### 计算结果示例

```
左手映射参数:
  X轴: scale=1.3333, offset=0.0000, RMSE=0.0050m
  Y轴: scale=0.2500, offset=0.9000, RMSE=0.0032m
  Z轴: scale=1.8333, offset=1.3500, RMSE=0.0041m

右手映射参数:
  X轴: scale=1.3333, offset=0.0000, RMSE=0.0048m
  Y轴: scale=0.2500, offset=0.9000, RMSE=0.0035m
  Z轴: scale=1.8333, offset=1.3500, RMSE=0.0039m
```

**RMSE** (均方根误差) 越小，拟合效果越好（通常 < 0.01m 表示良好）。

---

## 使用标定结果

### 自动加载

`vr_to_base_vr`节点启动时会自动检测并加载标定文件：

```bash
ros2 run dual_arms vr_to_base_vr.py
```

日志会显示：
```
[INFO] 加载标定文件: .../vr_mapping_calibration.yaml
[INFO] ✓ 标定参数已加载
[INFO] Left mapping: scale=[1.333 0.25 1.833], offset=[0. 0.9 1.35]
[INFO] Right mapping: scale=[1.333 0.25 1.833], offset=[0. 0.9 1.35]
```

### 手动覆盖参数

如需临时测试其他参数：

```bash
ros2 run dual_arms vr_to_base_vr.py \
  --ros-args \
  -p left_scale_x:=1.5 \
  -p left_offset_z:=1.0
```

---

## 标定建议

### 姿态选择原则

1. **覆盖工作空间边界**：选择覆盖机械臂工作空间各个方向的姿态
2. **避免奇异点**：不要选择关节接近极限的姿态
3. **便于重复**：选择容易记住和重复的标准姿态

### 推荐姿态组合

#### 标准姿态组（推荐）

1. **左右展开** - 覆盖X轴范围
2. **自然垂下** - 定义零点/下边界
3. **上举过顶** - 覆盖Y轴上限
4. **前伸** - 覆盖Z轴前方
5. **收回身体** - 覆盖Z轴后方

#### 替代姿态组

- 斜前方45°
- 斜后方45°
- 低位拾取姿态
- 高位放置姿态

### 精度优化技巧

1. **多次测量取平均**：对于关键位置，可以记录多次求平均
2. **使用机械臂示教**：让机械臂移动到目标位置，直接读取坐标
3. **验证边界点**：标定后测试工作空间边界，确保无碰撞

---

## 数学原理

### 问题定义

已知：
- VR空间5个点：`P_vr = [(x1,y1,z1), ..., (x5,y5,z5)]`
- 机械臂空间对应点：`P_robot = [(x1',y1',z1'), ..., (x5',y5',z5')]`

求解：`P' = diag(sx, sy, sz) * P + (ox, oy, oz)`

### 最小二乘解

对每个轴独立求解线性回归：

```
xi' = sx * xi + ox
yi' = sy * yi + oy
zi' = sz * zi + oz
```

构建矩阵方程 `A * [s, o]^T = b`，使用最小二乘法求解。

5个点提供15个方程，求解6个未知数（过定方程组），结果最优且鲁棒。

---

## 故障排除

### 问题：未接收到VR数据

**解决方法**：
1. 检查`vr_to_base_vr`节点是否运行：
   ```bash
   ros2 node list | grep vr_to_base_vr
   ```
2. 检查话题是否发布：
   ```bash
   ros2 topic echo /vr_base_vr/left_pose --once
   ```

### 问题：RMSE误差过大 (> 0.05m)

**可能原因**：
- 输入的机械臂位置不准确
- 姿态选择过于集中（未覆盖工作空间）
- VR跟踪漂移

**解决方法**：
- 使用机械臂示教获取精确坐标
- 重新选择更分散的姿态
- 重新标定VR系统

### 问题：标定后机械臂运动异常

**检查清单**：
1. 确认坐标系方向一致（base_vr: X右 Y上 Z后）
2. 检查标定文件中的参数是否合理
3. 验证单个轴的scale是否为正值
4. 测试单个轴运动，逐一排查

---

## 高级功能（可选）

### 添加旋转映射

如果需要同时映射姿态（四元数），可以扩展为：

```python
P' = R * S * P + offset
```

其中R是旋转矩阵。这需要使用更复杂的优化算法。

### 非线性映射

对于复杂工作空间，可以使用：
- 多项式映射
- 神经网络
- RBF插值

---

## 参考

- **标定工具**: `scripts/calibrate_vr_mapping.py`
- **运行时节点**: `scripts/vr_to_base_vr.py`
- **配置文件**: `config/vr_mapping_calibration.yaml`

## 联系支持

如有问题，请查看日志或联系技术支持。
