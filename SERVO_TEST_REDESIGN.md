# 伺服测试GUI重新设计

## 问题描述
之前的GUI设计中，伺服测试功能试图在伺服模式下使用 `robot_run_multi_movj()` 移动到初始位置。但是伺服模式下不允许使用阻塞式的点到点运动，导致测试无法正常执行。

## 解决方案
重新设计伺服控制标签页，将流程分为三个明确的步骤：

### 步骤1: 移动到初始位置
- 在**普通模式**下（使能后，伺服启动前）
- 使用MoveJ将机器人移动到零位 `[0,0,0,0,0,0,0,0,0,0,0,0,0,0]`
- 移动完成后显示"已到位 ✓"
- 只有到位后才能启动伺服模式

### 步骤2: 启动伺服模式
- 只有在到达初始位置后才能启用
- 启动伺服模式后，不再允许点到点运动
- 伺服模式运行中显示"伺服运行中 ✓"

### 步骤3: 伺服运动测试
- 只有在伺服模式启动后才能测试
- 执行正弦波关节运动测试（关节0,1,3）
- 使用伺服命令，频率125Hz

## 代码修改

### 1. 添加状态变量
```python
self.at_initial_position = False  # 是否已到达初始位置
```

### 2. 新增界面组件
- `btn_move_to_init` - 移动到初始位置按钮
- `init_position_label` - 位置状态标签

### 3. 新增功能函数
- `move_to_initial_position()` - 使用MoveJ移动到零位
- `on_initial_position_reached()` - 到位后的回调

### 4. 修改状态管理逻辑

#### 使能后
- 启用"移动到初始位置"按钮
- 禁用"启动伺服模式"按钮

#### 到达初始位置后
- 标记 `at_initial_position = True`
- 启用"启动伺服模式"按钮
- 禁用"移动到初始位置"按钮

#### 启动伺服模式后
- 启用"开始测试"按钮
- 禁用"移动到初始位置"按钮
- 启用VR跟随功能

#### 停止伺服模式后
- 如果仍在初始位置，可以重新启动伺服
- 如果已使能，可以重新移动到初始位置

#### 去使能时
- 重置 `at_initial_position = False`
- 所有按钮恢复初始状态

## 使用流程

### 正常测试流程
1. **基础控制**: 上电 → 使能
2. **移动到初始位置**: 点击"移动到初始位置"
3. **启动伺服**: 点击"启动伺服模式"
4. **开始测试**: 点击"开始测试"或启用VR跟随

### 重新测试流程
如果需要重新测试：
- 方案A: 停止伺服 → 重新启动伺服 → 开始测试
- 方案B: 停止伺服 → 移动到初始位置 → 启动伺服 → 开始测试

### 紧急停止
任何时候都可以：
- 点击"停止伺服模式"
- 点击"急停 (Abort)"
- 点击"去使能"或"下电"

## 关键技术点

### 为什么不能在伺服模式下移动
```cpp
// 伺服模式是实时控制模式，控制周期为8ms
// robot_run_multi_movj() 是阻塞式轨迹规划运动
// 两者不能同时进行
robot.servo_move_enable(1, 0);  // 启动伺服模式后
// ❌ robot.robot_run_multi_movj(...)  // 不能调用点到点运动
// ✓ robot.edg_servo_j(...)            // 只能使用伺服命令
// ✓ robot.edg_send()
```

### MoveJ vs 伺服控制的区别

| 特性 | MoveJ | 伺服控制 |
|------|-------|----------|
| 控制频率 | 低 (内部规划) | 高 (125Hz) |
| 轨迹规划 | 控制器内部 | 外部提供 |
| 模式 | 阻塞 | 实时 |
| 适用场景 | 初始化定位 | 实时跟随 |

## 测试验证

### 验证点1: 初始位置移动
```bash
# 启动GUI后
1. 上电
2. 使能
3. 点击"移动到初始位置"
Expected: 机器人平滑移动到零位，显示"已到位 ✓"
```

### 验证点2: 伺服启动
```bash
# 初始位置到位后
4. 点击"启动伺服模式"
Expected: 伺服模式启动成功，显示"伺服运行中 ✓"
```

### 验证点3: 伺服测试
```bash
# 伺服模式启动后
5. 点击"开始测试"
Expected: 机器人关节0,1,3执行正弦波运动
```

### 验证点4: 停止和重启
```bash
6. 点击"停止测试"
7. 点击"停止伺服模式"
Expected: 伺服模式停止，可以重新启动或移动
```

## 界面布局

```
┌─────────────────────────────────────┐
│ ● 步骤1: 移动到初始位置             │
│   位置状态: 未到位                  │
│   [移动到初始位置]                  │
│   说明: 在普通模式下移动到零位      │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│ ● 步骤2: 启动伺服模式               │
│   伺服状态: 未启动                  │
│   [启动伺服模式] [停止伺服模式]    │
│   说明: 到达初始位置后启动伺服模式  │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│ ● 步骤3: 伺服运动测试               │
│   测试状态: 未测试                  │
│   [开始测试]                        │
│   说明: 执行慢速正弦波关节运动测试  │
└─────────────────────────────────────┘

┌─────────────────────────────────────┐
│ ● 使用说明                          │
│   伺服模式使用流程：                │
│   1. 基础控制：上电 → 使能          │
│   2. 移动到初始位置（零位）         │
│   3. 启动伺服模式                   │
│   4. 开始测试或VR跟随               │
└─────────────────────────────────────┘
```

## 相关文件
- GUI实现: `qyh_jaka_control_gui/jaka_complete_gui.py`
- 伺服修复文档: `SERVO_FIX.md`
- SDK参考: `jakaAPI_K1_2.3.3_DUAL_x64/example/c++/30.edgservo.cpp`

## 注意事项

1. **安全第一**: 测试前确保机器人周围无障碍物
2. **初始位置**: 零位是所有关节角度为0，确保此姿态安全
3. **伺服频率**: 125Hz (8ms周期)，不要修改
4. **测试幅度**: 当前测试为小幅度正弦波，可根据需要调整
5. **紧急停止**: 随时可以点击急停或去使能

## 未来改进
- [ ] 支持自定义初始位置
- [ ] 添加初始位置预设列表
- [ ] 显示移动进度条
- [ ] 添加碰撞检测设置提醒
- [ ] 记录测试数据到文件
